version: '3'

services:
  #
  # taiga-frontend
  #
  taiga-frontend:
    build:
      context: .
      dockerfile: Dockerfile.frontend
      args:
        NO_PROXY: ${NO_PROXY}
        FTP_PROXY: ${FTP_PROXY}
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
    image: takumi/taiga-frontend
    container_name: taiga-frontend
    restart: always
    environment:
      TAIGA_FRONTEND_EVENTS_BASE_URI: ${TAIGA_FRONTEND_EVENTS_BASE_URI}
      TAIGA_FRONTEND_BACKEND_BASE_URI: ${TAIGA_FRONTEND_BACKEND_BASE_URI}
    networks:
      - taiga
    ports:
      - ${TAIGA_FRONTEND_PORT}:80
    depends_on:
      - taiga-events
      - taiga-backend

  #
  # taiga-events
  #
  taiga-events:
    build:
      context: .
      dockerfile: Dockerfile.events
      args:
        NO_PROXY: ${NO_PROXY}
        FTP_PROXY: ${FTP_PROXY}
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
    image: takumi/taiga-events
    container_name: taiga-events
    restart: always
    environment:
      TAIGA_EVENTS_SECRET: ${TAIGA_EVENTS_SECRET}
      TAIGA_EVENTS_RABBITMQ_HOST: taiga-events-rabbitmq
      TAIGA_EVENTS_RABBITMQ_PORT: 5672
      TAIGA_EVENTS_RABBITMQ_USER: taiga-events
      TAIGA_EVENTS_RABBITMQ_PASS: taiga-events
    networks:
      - taiga
    ports:
      - ${TAIGA_EVENTS_PORT}:8888
    depends_on:
      - taiga-events-rabbitmq

  taiga-events-rabbitmq:
    image: rabbitmq:alpine
    container_name: taiga-events-rabbitmq
    restart: always
    environment:
      RABBITMQ_DEFAULT_VHOST: taiga-events
      RABBITMQ_DEFAULT_USER: taiga-events
      RABBITMQ_DEFAULT_PASS: taiga-events
    volumes:
      - taiga-events-rabbitmq:/var/lib/rabbitmq
    networks:
      - taiga

  #
  # taiga-backend
  #
  taiga-backend:
    build:
      context: .
      dockerfile: Dockerfile.backend
      args:
        NO_PROXY: ${NO_PROXY}
        FTP_PROXY: ${FTP_PROXY}
        HTTP_PROXY: ${HTTP_PROXY}
        HTTPS_PROXY: ${HTTPS_PROXY}
        UBUNTU_MIRROR: ${UBUNTU_MIRROR}
    image: takumi/taiga-backend
    container_name: taiga-backend
    restart: always
    networks:
      - taiga
    # ports:
    #   - ${TAIGA_FRONTEND_PORT}:80

networks:
  taiga:

volumes:
  taiga-events-rabbitmq:
